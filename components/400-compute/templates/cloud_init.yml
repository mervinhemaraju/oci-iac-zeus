#cloud-config
# Cloud-init configuration for GitHub Actions Runner

users:
  - name: opc
    groups: sudo
    shell: /bin/bash
    homedir: /home/opc
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - "${authorized_ssh_key}"

  - name: th3pl4gu3
    groups: sudo
    shell: /bin/bash
    homedir: /home/th3pl4gu3
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - "${authorized_ssh_key}"

  - name: githubrunner
    groups: sudo,docker
    shell: /bin/bash
    homedir: /home/githubrunner
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - "${authorized_ssh_key}"

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - jq
  - libicu
  - openssl-devel
  - git
  - tar
  - python3-pip
  - python39-oci-cli

write_files:
  # Set up environment variables
  - path: /etc/environment
    permissions: "0644"
    content: |
      GITHUB_PAT=${github_pat}
      GITHUB_ORG=plagueworks-org
    append: true

  # Run the setup script to configure the GitHub runner
  - path: /tmp/setup_runner.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -e

      # Configuration
      GITHUB_ORG="plagueworks-org"
      GITHUB_PAT="${github_pat}"

      # Get runner registration token from GitHub API
      RUNNER_TOKEN=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_PAT" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/orgs/$GITHUB_ORG/actions/runners/registration-token" \
          | jq -r '.token')

      # Create runner directory in /opt (better for SELinux)
      mkdir -p /opt/github-runner
      cd /opt/github-runner

      # Download the latest runner package
      curl -o actions-runner-linux-arm64.tar.gz -L https://github.com/actions/runner/releases/download/v2.327.1/actions-runner-linux-arm64-2.327.1.tar.gz

      # Extract the package
      tar xzf ./actions-runner-linux-arm64.tar.gz

      # Set ownership to githubrunner user
      chown -R githubrunner:githubrunner /opt/github-runner

      # Configure the runner (non-interactive)
      sudo -u githubrunner bash -c "cd /opt/github-runner && ./config.sh --url https://github.com/plagueworks-org --token $RUNNER_TOKEN --unattended --replace"

  # Create systemd service for the GitHub runner
  - path: /etc/systemd/system/github-runner.service
    permissions: "0644"
    content: |
      [Unit]
      Description=GitHub Actions Runner
      After=network.target
      Wants=network.target

      [Service]
      Type=simple
      User=githubrunner
      Group=githubrunner
      WorkingDirectory=/opt/github-runner
      ExecStart=/opt/github-runner/run.sh
      Restart=always
      RestartSec=5
      Environment="GITHUB_PAT=${github_pat}"
      Environment="GITHUB_ORG=plagueworks-org"

      [Install]
      WantedBy=multi-user.target

  # Setup Python aliases
  - path: /etc/profile.d/python-aliases.sh
    permissions: "0644"
    content: |
      #!/bin/bash
      # System-wide Python aliases
      alias python=python3
      alias pip=pip3
      export PATH=$PATH:/usr/local/bin

  # Setup OCI CLI configuration
  - path: /home/githubrunner/.oci/config
    permissions: "0600"
    owner: "githubrunner:githubrunner"
    content: |
      [OCI-HELIOS]
      user=${oci_user_ocid_helios}
      fingerprint=${oci_fingerprint}
      tenancy=${oci_tenancy_ocid_helios}
      region=af-johannesburg-1
      key_file=/home/githubrunner/.oci/keys/oci_api_private_key.pem

      [OCI-ZEUS]
      user=${oci_user_ocid_zeus}
      fingerprint=${oci_fingerprint}
      tenancy=${oci_tenancy_ocid_zeus}
      region=af-johannesburg-1
      key_file=/home/githubrunner/.oci/keys/oci_api_private_key.pem

      [OCI-POSEIDON]
      user=${oci_user_ocid_poseidon}
      fingerprint=${oci_fingerprint}
      tenancy=${oci_tenancy_ocid_poseidon}
      region=uk-south-1
      key_file=/home/githubrunner/.oci/keys/oci_api_private_key.pem

      [OCI-GAIA]
      user=${oci_user_ocid_gaia}
      fingerprint=${oci_fingerprint}
      tenancy=${oci_tenancy_ocid_gaia}
      region=uk-south-1
      key_file=/home/githubrunner/.oci/keys/oci_api_private_key.pem

  # Setup OCI API Private Key
  - path: /home/githubrunner/.oci/keys/oci_api_private_key.pem
    permissions: "0600"
    owner: "githubrunner:githubrunner"
    encoding: b64
    content: ${oci_api_private_key_base64}

  # Setup OCI Compute Private Key
  - path: /home/githubrunner/.oci/keys/oci_compute_private_key.pem
    permissions: "0600"
    owner: "githubrunner:githubrunner"
    encoding: b64
    content: ${oci_compute_private_key_base64}

  # Setup OCI API Public Key
  - path: /home/githubrunner/.oci/keys/oci_api_public_key.pem
    permissions: "0600"
    owner: "githubrunner:githubrunner"
    encoding: b64
    content: ${oci_api_public_key_base64}

  # Setup OCI Compute Public Key
  - path: /home/githubrunner/.oci/keys/oci_compute_public_key.pem
    permissions: "0600"
    owner: "githubrunner:githubrunner"
    encoding: b64
    content: ${oci_compute_public_key_base64}

runcmd:
  # Install Docker
  - dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
  - dnf install docker-ce -y
  - systemctl start docker
  - systemctl enable docker

  # Add githubrunner user to docker group (if not already done)
  - usermod -aG docker githubrunner
  - usermod -aG docker opc
  - usermod -aG docker th3pl4gu3

  # Ensure githubrunner has full ownership of their home directory
  # - chown -R githubrunner:githubrunner /home/githubrunner
  # - chmod -R 755 /home/githubrunner

  # Source environment variables and run setup script
  - bash -c "source /etc/environment && /tmp/setup_runner.sh"

  # Enable and start the GitHub runner service
  - systemctl daemon-reload
  - systemctl enable github-runner.service
  - systemctl start github-runner.service

# Final message
final_message: "GitHub Runner setup completed successfully!"
